- job:
    name: dell-base
    parent: null
    pre-run: playbooks/base/pre.yaml
    post-run: 
      - playbooks/base/post-logs.yaml
      - name: playbooks/base/cleanup.yaml
        cleanup: true
    roles:
      - zuul: zuul/zuul-jobs
    nodeset:
      nodes:
        - name: controller
          label: ubuntu-jammy

- job:
    name: devstack-base
    parent: dell-base
    abstract: true
    description: |
      Base abstract Devstack job.

      Defines plays and base variables, but it does not include any project
      and it does not run any service by default. This is a common base for
      all single Devstack jobs, single or multinode.
      Variables are defined in job.vars, which is what is then used by single
      node jobs and by multi node jobs for the controller, as well as in
      job.group-vars.peers, which is what is used by multi node jobs for subnode
      nodes (everything but the controller).      
    required-projects:
      - opendev.org/openstack/devstack
    roles:
      - zuul: opendev.org/openstack/openstack-zuul-jobs
    vars:
      devstack_localrc:
        DATABASE_PASSWORD: secretdatabase
        RABBIT_PASSWORD: secretrabbit
        ADMIN_PASSWORD: secretadmin
        SERVICE_PASSWORD: secretservice
        NETWORK_GATEWAY: 10.1.0.1
        FIXED_RANGE: 10.1.0.0/20
        IPV4_ADDRS_SAFE_TO_USE: 10.1.0.0/20
        FLOATING_RANGE: 172.24.5.0/24
        PUBLIC_NETWORK_GATEWAY: 172.24.5.1
        LOGFILE: /opt/stack/logs/devstacklog.txt
        LOG_COLOR: false
        VERBOSE: true
        VERBOSE_NO_TIMESTAMP: true
        NOVNC_FROM_PACKAGE: true
        ERROR_ON_CLONE: false
        # Gate jobs can't deal with nested virt. Disable it by default.
        LIBVIRT_TYPE: '{{ devstack_libvirt_type | default("qemu") }}'
      devstack_services:
        # Ignore any default set by devstack. Emit a "disable_all_services".
        base: false
      zuul_copy_output:
        '{{ devstack_conf_dir }}/local.conf': logs
        '{{ devstack_conf_dir }}/localrc': logs
        '{{ devstack_conf_dir }}/.localrc.auto': logs
        '{{ devstack_conf_dir }}/.stackenv': logs
        '{{ devstack_log_dir }}/dstat-csv.log': logs
        '{{ devstack_log_dir }}/devstacklog.txt': logs
        '{{ devstack_log_dir }}/devstacklog.txt.summary': logs
        '{{ devstack_log_dir }}/tcpdump.pcap': logs
        '{{ devstack_log_dir }}/worlddump-latest.txt': logs
        '{{ devstack_log_dir }}/qemu.coredump': logs
        '{{ devstack_full_log}}': logs
        '{{ stage_dir }}/verify_tempest_conf.log': logs
        '{{ stage_dir }}/performance.json': logs
        '{{ stage_dir }}/apache': logs
        '{{ stage_dir }}/apache_config': logs
        '{{ stage_dir }}/etc': logs
        /var/log/rabbitmq: logs
        /var/log/postgresql: logs
        /var/log/mysql: logs
        /var/log/libvirt: logs
        /etc/libvirt: logs
        /etc/lvm: logs
        /etc/sudoers: logs
        /etc/sudoers.d: logs
        '{{ stage_dir }}/iptables.txt': logs
        '{{ stage_dir }}/df.txt': logs
        '{{ stage_dir }}/pip2-freeze.txt': logs
        '{{ stage_dir }}/pip3-freeze.txt': logs
        '{{ stage_dir }}/dpkg-l.txt': logs
        '{{ stage_dir }}/rpm-qa.txt': logs
        '{{ stage_dir }}/core': logs
        '{{ stage_dir }}/listen53.txt': logs
        '{{ stage_dir }}/services.txt': logs
        '{{ stage_dir }}/deprecations.log': logs
        '{{ stage_dir }}/audit.log': logs
        /etc/ceph: logs
        /var/log/ceph: logs
        /var/log/openvswitch: logs
        /var/log/glusterfs: logs
        /etc/glusterfs/glusterd.vol: logs
        /etc/resolv.conf: logs
        /var/log/unbound.log: logs
      extensions_to_txt:
        conf: true
        log: true
        localrc: true
        stackenv: true
        auto: true
    pre-run: playbooks/pre-devstack.yaml
    run: playbooks/run-devstack.yaml
    post-run: playbooks/post-devstack.yaml
    irrelevant-files:
      # Documentation related
      - ^.*\.rst$
      - ^api-ref/.*$
      - ^doc/.*$
      - ^releasenotes/.*$
      # Translations
      - ^.*/locale/.*po$
      # pre-commit config
      - ^.pre-commit-config.yaml$

- job:
    name: devstack-minimal
    parent: devstack-base
    description: |
      Minimal devstack base job, intended for use by jobs that need
      less than the normal minimum set of required-projects.      
    required-projects:
      - opendev.org/openstack/requirements
    vars:
      devstack_localrc:
        SERVICE_HOST: "{{ hostvars['controller']['nodepool']['public_ipv4'] }}"
        HOST_IP: "{{ hostvars['controller']['nodepool']['public_ipv4'] }}"
        #PUBLIC_BRIDGE_MTU: '{{ external_bridge_mtu }}'
        DATABASE_TYPE: mysql
        RABBIT_HOST: "{{ hostvars['controller']['nodepool']['public_ipv4'] }}"
        DATABASE_HOST: "{{ hostvars['controller']['nodepool']['public_ipv4'] }}"
      devstack_services:
        # Shared services
        dstat: false
        etcd3: true
        memory_tracker: true
        file_tracker: true
        mysql: true
        rabbit: true
        openstack-cli-server: true

- job:
    name: devstack
    parent: devstack-minimal
    description: |
      Base devstack job for integration gate.

      This base job can be used for single node and multinode devstack jobs.

      With a single node nodeset, this job sets up an "all-in-one" (aio)
      devstack with the seven OpenStack services included in the devstack tree:
      keystone, glance, cinder, neutron, nova, placement, and swift.

      With a two node nodeset, this job sets up an aio + compute node.
      The controller can be customised using host-vars.controller, the
      sub-nodes can be customised using group-vars.subnode.

      Descendent jobs can enable / disable services, add devstack configuration
      options, enable devstack plugins, configure log files or directories to be
      transferred to the log server.

      The job assumes that there is only one controller node. The number of
      subnodes can be scaled up seamlessly by setting a custom nodeset in
      job.nodeset.

      The run playbook consists of a single role, so it can be easily rewritten
      and extended.
    required-projects:
      - opendev.org/openstack/cinder
      - opendev.org/openstack/glance
      - opendev.org/openstack/keystone
      - opendev.org/openstack/neutron
      - opendev.org/openstack/nova
      - opendev.org/openstack/placement
      - opendev.org/openstack/swift
      - opendev.org/openstack/os-test-images
    timeout: 7200
    vars:
      # based on observation of the integrated gate
      # tempest-integrated-compute was only using ~1.7GB of swap
      # when zswap and the host turning are enabled that increase
      # slightly to ~2GB. we are setting the swap size to 8GB to
      # be safe and account for more complex scenarios.
      # we should revisit this value after some time to see if we
      # can reduce it.
      configure_swap_size: 8192
      devstack_localrc:
        # Common OpenStack services settings
        SWIFT_REPLICAS: 1
        SWIFT_START_ALL_SERVICES: false
        SWIFT_HASH: 1234123412341234
        DEBUG_LIBVIRT_COREDUMPS: true
        NOVA_VNC_ENABLED: true
        OVN_DBS_LOG_LEVEL: dbg
        # tune the host to optimize memory usage and hide io latency
        # these setting will configure the kernel to treat the host page
        # cache and swap with equal priority, and prefer deferring writes
        # changing the default swappiness, dirty_ratio and
        # the vfs_cache_pressure
        ENABLE_SYSCTL_MEM_TUNING: true
        # the net tuning optimizes ipv4 tcp fast open and config the default
        # qdisk policy to pfifo_fast which effectively disable all qos.
        # this minimizes the cpu load of the host network stack
        ENABLE_SYSCTL_NET_TUNING: true
        # zswap allows the kernel to compress pages in memory before swapping
        # them to disk. this can reduce the amount of swap used and improve
        # performance. effectively this trades a small amount of cpu for an
        # increase in swap performance by reducing the amount of data
        # written to disk. the overall speedup is proportional to the
        # compression ratio and the speed of the swap device.
        # NOTE: this option is ignored when not using nova with the libvirt
        # virt driver.
        NOVA_LIBVIRT_TB_CACHE_SIZE: 128
        ENABLE_ZSWAP: true
      devstack_services:
        # Core services enabled for this branch.
        # This list replaces the test-matrix.
        # Shared services
        dstat: false
        etcd3: true
        memory_tracker: true
        file_tracker: true
        mysql: true
        rabbit: true
        tls-proxy: true
        # Keystone services
        key: true
        # Glance services
        g-api: true
        # Nova services
        n-api: true
        n-api-meta: true
        n-cond: true
        n-cpu: true
        n-novnc: true
        n-sch: true
        # Placement service
        placement-api: true
        # OVN services
        ovn-controller: true
        ovn-northd: true
        ovs-vswitchd: true
        ovsdb-server: true
        # Neutron services
        q-svc: true
        q-ovn-metadata-agent: true
        # Swift services
        s-account: true
        s-container: true
        s-object: true
        s-proxy: true
        # Cinder services
        c-api: true
        c-bak: true
        c-sch: true
        c-vol: true
        # Services we don't need.
        # This section is not really needed, it's for readability.
        horizon: false
        tempest: false
        # Test matrix emits ceilometer but ceilomenter is not installed in the
        # integrated gate, so specifying the services has not effect.
        # ceilometer-*: false

- job:
    name: devstack-tempest
    parent: devstack
    description: |
      Base Tempest job.

      This Tempest job provides the base for both the single and multi-node
      test setup. To run a multi-node test inherit from devstack-tempest and
      set the nodeset to a multi-node one.
    required-projects: &base_required-projects
      - opendev.org/openstack/tempest
    timeout: 7200
    vars: &base_vars
      devstack_services:
        tempest: true
      devstack_local_conf:
      test_results_stage_name: test_results
      zuul_copy_output:
        '{{ devstack_base_dir }}/tempest/etc/tempest.conf': logs
        '{{ devstack_base_dir }}/tempest/etc/accounts.yaml': logs
        '{{ devstack_base_dir }}/tempest/tempest.log': logs
        '{{ stage_dir }}/{{ test_results_stage_name }}.subunit': logs
        '{{ stage_dir }}/{{ test_results_stage_name }}.html': logs
        '{{ stage_dir }}/stackviz': logs
      extensions_to_txt:
        conf: true
        log: true
        yaml: true
        yml: true
    run: playbooks/devstack-tempest.yaml
    post-run: playbooks/post-tempest.yaml

- job:
    name: devstack-cinder-plugin-tempest-base
    abstract: true 
    parent: devstack-tempest
    description: |
      Base tempest job with cinder plugin.

      This job doesn't configure any backend but install the cinder plugin for tempest.
    required-projects:
      - openstack/cinder-tempest-plugin
    irrelevant-files: &irrelevant-files
      - ^.*\.rst$
      - ^doc/.*$
      - ^tox.ini$
    timeout: 7200
    vars:
      tempest_concurrency: 2
      devstack_localrc:
        TEMPEST_PLUGINS: 'cinder-tempest-plugin'
      devstack_services:
        horizon: false
      tox_envlist: all
      tempest_test_regex: |
        volume

- job: 
    name: powerflex-backend-cinder-tempest
    parent: devstack-cinder-plugin-tempest-base
    description: |
      Runs cinder tempest plugin tests with Dell PowerFlex
    vars:
      devstack_localrc:
        CINDER_ENABLED_BACKENDS: powerflex1,powerflex2
        TEMPEST_CONCURRENCY: 2
        TEMPEST_EXTEND_ATTACHED_VOLUME: true
        TEMPEST_VOLUME_DRIVER: EMC
        TEMPEST_VOLUME_VENDOR: 'Dell EMC'
        TEMPEST_STORAGE_PROTOCOL: scaleio
        ENABLE_VOLUME_MULTIATTACH: true
      devstack_local_conf:
        post-config:
          $CINDER_CONF:
            powerflex1:
              volume_backend_name: powerflex1
            powerflex2:
              volume_backend_name: powerflex1
            backend_defaults:
              suppress_requests_ssl_warnings: True
              volume_driver: cinder.volume.drivers.dell_emc.powermax.iscsi.PowerFlexDriver
              image_volume_cache_enabled: True
              san_ip: 10.228.225.213
              san_login: adminc
              san_password: #1Danger0us
              powerflex_storage_pools: OpenstackPD:OpenstackSP0
          $NOVA_CONF:
            libvirt:
              volume_use_multipath: True
      tempest_test_regex: |
        volume|^cinder_tempest_plugin 
